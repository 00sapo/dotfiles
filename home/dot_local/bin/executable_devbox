#!/bin/env fish

/usr/local/bin/devbox $argv

if test "$argv[1]" = global
    for i in $HOME/.local/share/devbox/global/default/.devbox/nix/profile/default/share/applications/*.desktop
        sed "s/Exec=/Exec=\/usr\/local\/bin\/devbox global run -- /" $i >$HOME/.local/share/applications/(basename $i)
    end

    for i in $HOME/.local/share/applications/*.desktop
        # take the first word of the Exec= line
        set exec (grep -oP '^Exec=\K[^ ]+' $i)
        # check if the first word doesn't exist as a command in the path
        for e in $exec
            if not command -v $e >/dev/null
                echo "$i should be removed because $e doesn't exist" >&2
            end
        end
    end
end
