#!/bin/env fish

/usr/local/bin/devbox $argv

if test "$argv[1]" = global

    # syncing .desktop files
    set requiregl (cat $HOME/.local/share/devbox/global/default/requiregl.conf)
    for i in $HOME/.local/share/devbox/global/default/.devbox/nix/profile/default/share/applications/*.desktop
        set base (basename $i)
        # check if $base is in $requiregl
        if echo $requiregl | grep -q $base
            sed "s/Exec=/Exec=prime-run nixGL \/usr\/local\/bin\/devbox global run -- /" $i >$HOME/.local/share/applications/$base
        else
            sed "s/Exec=/Exec=\/usr\/local\/bin\/devbox global run -- /" $i >$HOME/.local/share/applications/$base
        end
    end

    # checking which .desktop files are not needed anymore
    for i in $HOME/.local/share/applications/*.desktop
        # take the first word of the Exec= lines
        set exec (grep -oP '^Exec=\K[^ ]+' $i)
        # check if the first word doesn't exist as a command in the path
        for e in $exec
            if not command -v $e >/dev/null
                echo "$i should be removed because $e doesn't exist" >&2
            end
        end
    end
end
